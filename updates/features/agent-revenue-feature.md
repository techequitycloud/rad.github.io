# Agent Revenue & Commission Feature

This document outlines the implementation and logic behind the Agent Revenue and Commission feature on the platform. This feature allows Agents to track revenue generated by the users they have referred to the platform.

## 1. Overview

The Agent Revenue feature enables a commission-based incentive model. Agents earn a percentage of the **"True Revenue"** generated by their referred users.

*   **Role:** `Agent`
*   **Key Metric:** "True Revenue" (Revenue generated from *paid* credits only).
*   **Commission:** A configurable percentage of the True Revenue.
*   **Scope:** Agents only see data for users they have explicitly referred.

## 2. Key Concepts

### 2.1 True Revenue
The platform distinguishes between **Free Credits** (awarded by the platform) and **Paid Credits** (purchased by users). Agents **only** earn commission on deployments paid for with *purchased* credits.

The system calculates this chronologically:
1.  A user's total pool of "Free Credits" is calculated.
2.  As the user deploys modules, the cost is deducted from this "Free Credit" pool first.
3.  Once the "Free Credit" pool is exhausted, subsequent deployment costs are considered "Paid Revenue".

### 2.2 Agent Commission
The commission is calculated as a percentage of the gross paid revenue.
*   **Formula:** `Commission = (Paid Credit Cost / Credits Per Unit) * Agent Revenue Share %`
*   **Example:**
    *   Deployment Cost: 100 Credits (all paid)
    *   Credits Per Unit: 10 (1 Unit = $1.00, so 100 credits = $10.00)
    *   Agent Revenue Share: 10%
    *   **Commission:** ($10.00) * 10% = **$1.00**

### 2.3 Referral Scope
An Agent is linked to a user via the `referredBy` field in the user's profile. An agent can only view and earn revenue from users where `user.referredBy === agent.email`.

## 3. User Interface

Agents access this data via the **Billing** section of the application.

### 3.1 User Revenue Tab
This is the primary view for Agents.
*   **Function:** View revenue broken down by individual referred users.
*   **Filters:**
    *   **Select Users:** A multi-select dropdown populated *only* with users referred by the Agent.
    *   **Date Range:** Start and End date for the report.
*   **Data Points:** User Email, Module Name, Deployment Date, Credit Cost, and **Revenue** (Commission earned).

### 3.2 Module Revenue Tab
*   **Function:** View revenue aggregated by specific modules deployed by their referred users.
*   **Filters:** Select specific modules and date ranges.

### 3.3 Export
Both views support exporting the data to CSV for external analysis or invoicing.

## 4. Configuration (Admin)

Administrators control the global variables that dictate revenue calculation. These are managed in **Admin -> Credit Settings**.

*   **Credits Per Unit:** The exchange rate for converting credits to currency (e.g., 10 credits = 1 Unit of currency).
*   **Agent Revenue Share:** The global percentage (0-100) of revenue that is paid out as commission to agents.

## 5. Technical Implementation Details

### 5.1 Backend Logic (`/api/revenue`)
The core calculation resides in the `calculateTrueRevenue` function:
1.  **Authorization:** The API strictly enforces that Agents can only query users where `referredBy` matches their email.
2.  **Chronological Accounting:** It iterates through a user's deployment history sorted by time. It tracks a running total of `spentFreeCredits` against the user's lifetime `totalFreeCredits`.
3.  **Revenue Recognition:**
    *   If `spentFreeCredits < totalFreeCredits`: The deployment is considered free (or partially free). No revenue (or partial revenue) is recorded.
    *   If `spentFreeCredits >= totalFreeCredits`: The deployment is fully paid. Full revenue is recorded.
4.  **Share Calculation:** If the user is an Agent and the deployment belongs to their referral, the `agentRevenueShare` percentage is applied to the gross revenue before returning the data.

### 5.2 Data Flow
1.  **Frontend:** `UserRevenue.tsx` fetches the list of referred users (`/api/users/referred`) to populate the filter dropdown.
2.  **Request:** The user selects filters and requests revenue data.
3.  **Processing:** The API fetches all relevant deployments and credit transactions (awards) to perform the "True Revenue" calculation on the fly.
4.  **Response:** The API returns the calculated commission amounts, which are displayed directly in the UI.

### 5.3 Security
*   **Role-Based Access:** Protected by `withAuth` middleware and role checks (`isAgent`).
*   **Data Scoping:** Queries are hard-coded to filter by `referredBy` for Agent users, preventing access to platform-wide data.
