# Subscription Tier Management Feature

## Overview

The Subscription Tier Management feature allows platform administrators and finance teams to create, manage, and monetize subscription plans. It integrates with Stripe for payment processing and provides a seamless experience for users to subscribe to different service levels (e.g., Professional, Startup, SMB, Enterprise).

This feature is divided into two main components:
1.  **Admin Management:** For creating and editing subscription tiers.
2.  **User Subscription:** For users to view available plans and manage their subscriptions.

## Data Model

The subscription tier data is stored in the `subscription_tiers` Firestore collection. Each tier object (`ISubscriptionTier`) contains the following fields:

| Field | Type | Description |
| :--- | :--- | :--- |
| `id` | String | Unique identifier for the tier (auto-generated by Firestore). |
| `name` | String | Display name of the tier (e.g., "Professional"). |
| `description` | String | A brief description of the tier's target audience or value proposition. |
| `price` | Number | The monthly cost of the subscription. |
| `priceId` | String | The corresponding Price ID from Stripe (e.g., `price_12345`). |
| `credits` | Number | The number of credits awarded to the user per billing cycle. |
| `features` | Array\<String\> | A list of feature highlights displayed on the subscription card. |
| `period` | String | The billing frequency (e.g., "month", "year"). |
| `isActive` | Boolean | (Optional) Whether the tier is currently available for new subscriptions. |

## User Roles & Permissions

Access to the subscription features is controlled by user roles:

*   **Admin (`isAdmin`) / Finance (`isFinance`):**
    *   Full CRUD (Create, Read, Update, Delete) access to subscription tiers.
    *   Can configure the Stripe integration settings.
*   **User (`isUser`) / Partner (`isPartner`) / Support (`isSupport`):**
    *   Read-only access to view available subscription tiers.
    *   Ability to subscribe to a plan via Stripe Checkout.
    *   Ability to view their current subscription status and cancel their subscription.

## Admin Workflow

Administrators manage subscription tiers via the **Subscription Tier Management** component found in the Admin Dashboard.

### 1. Creating a Tier
*   Click the **"Add New Tier"** button.
*   Fill in the required fields:
    *   **Name:** The plan name.
    *   **Price:** The monthly cost.
    *   **Stripe Price ID:** The ID of the price object created in the Stripe Dashboard.
    *   **Credits:** The monthly credit allowance.
    *   **Features:** Add bullet points for plan features.
*   Click **"Save"**. The new tier is immediately available to users.

### 2. Updating a Tier
*   Click the **"Edit"** button next to an existing tier.
*   Modify the desired fields.
*   Click **"Save"**. Changes are reflected immediately via optimistic UI updates.

### 3. Deleting a Tier
*   Click the **"Delete"** button.
*   Confirm the action. This removes the tier from the database, preventing new subscriptions. Existing subscriptions in Stripe must be managed separately.

## User Workflow

Users access subscription options via the **Credits & Billing** section of the application.

### 1. Viewing Plans
*   Users are presented with a list of available tiers, sorted by logical progression (Professional -> Startup -> SMB -> Enterprise).
*   Each card displays the price, credit allowance, and key features.

### 2. Subscribing
*   Clicking **"Subscribe"** on a tier card initiates the workflow.
*   The system creates a Stripe Checkout Session via the `/api/stripe/subscription-checkout` endpoint.
*   The user is redirected to the secure Stripe hosted payment page.
*   Upon successful payment, the user is redirected back to the application, and their subscription status is updated.

### 3. Managing Subscription
*   If a user has an active subscription, the corresponding card is highlighted.
*   The **"Cancel Subscription"** button allows users to cancel auto-renewal.
*   Cancellation takes effect at the end of the current billing period (`cancel_at_period_end`).

## API Endpoints

The feature is powered by the following Next.js API routes:

### Tier Management
*   **`GET /api/subscriptions/tiers`**: Fetches all available subscription tiers. Public for authenticated users.
*   **`POST /api/subscriptions/tiers`**: Creates a new tier. Restricted to Admin/Finance.
*   **`GET /api/subscriptions/tiers/[id]`**: Fetches details for a single tier.
*   **`PUT /api/subscriptions/tiers/[id]`**: Updates an existing tier. Restricted to Admin/Finance.
*   **`DELETE /api/subscriptions/tiers/[id]`**: Deletes a tier. Restricted to Admin/Finance.

### Stripe Integration
*   **`POST /api/stripe/subscription-checkout`**: Creates a Stripe Checkout Session for a selected tier. Includes rate limiting to prevent abuse.
*   **`POST /api/stripe/cancel-subscription`**: Sets a user's subscription to cancel at the end of the current billing period.
*   **`GET /api/account/subscription`**: Retrieves the current user's subscription status.

## Technical Implementation Details

*   **Frontend:** Built with React, utilizing `tanstack/react-query` for efficient data fetching, caching, and optimistic updates. UI components use Tailwind CSS and DaisyUI.
*   **Backend:** Next.js API routes handle business logic and role-based access control (RBAC).
*   **Database:** Google Cloud Firestore stores tier definitions and user subscription metadata.
*   **Payments:** Stripe is the exclusive payment processor. The backend uses the `stripe` Node.js library to interact with the Stripe API.
*   **State Management:** `Zustand` is used for global user state (roles, credits), while React Query manages server state (tiers list).
