# Module Management Feature

This document outlines the implementation of the module management feature on the platform, focusing on the user experience and technical workflow **once a deployment is performed**.

## 1. Overview

The module management feature allows users to oversee the lifecycle of their deployed infrastructure. After a user deploys a module, they can monitor its status, view detailed logs, rate the module, and manage the deployment's lifecycle (including updates and deletion).

The implementation is centered around the following key components and routes:
-   **Deployments List (`Deployments.tsx`)**: A dashboard for viewing and rating all deployments.
-   **Deployment Details (`DeploymentDetails.tsx`)**: A detailed view for a single deployment, including logs and builds.
-   **Deployments Table (`ModuleDeployment.tsx`)**: The core UI component for rendering the sortable list of deployments.

---

## 2. Viewing and Rating Deployments

### 2.1. Deployments Dashboard
**File:** `rad-ui/webapp/src/routes/Deployments.tsx`

The Deployments page serves as the main dashboard. It provides two views based on user roles:
-   **My Deployments**: Visible to all users. Shows deployments created by the current user.
-   **All Deployments**: Visible only to Admins and Support staff. Shows all deployments across the platform.

**Technical Implementation:**
-   **Data Fetching**: Uses the `useDeployments` hook, which establishes a real-time listener (`onSnapshot`) to the Firestore `deployments` collection. This ensures the list updates instantly when a deployment status changes (e.g., from `QUEUED` to `SUCCESS`).
-   **Sorting**: Deployments are sorted by `createdAt` in descending order (newest first).
-   **Status Indicators**: Each row displays a color-coded status badge (e.g., Green for `SUCCESS`, Red for `FAILURE`, Yellow for `QUEUED`/`WORKING`) derived from the `status` field in the Firestore document.

### 2.2. Rating a Deployment
**File:** `rad-ui/webapp/src/components/modules/ModuleDeployment.tsx`

Users can rate the module they deployed directly from the deployments list, providing feedback on its quality and utility.

-   **UI**: A 5-star rating component is displayed within each row of the deployments table.
-   **Behavior**:
    -   Users click a star to set a rating (1-5).
    -   **Optimistic Update**: The UI updates immediately to reflect the user's choice using local state.
    -   **API Call**: A `PATCH` request is sent to `/api/deployments/[id]` with the new `rating`.
    -   **Backend Aggregation**: The backend updates the deployment record and transactionally recalculates the `averageRating` and `ratingCount` for the parent module, ensuring the module's public rating is always accurate.

---

## 3. Managing a Deployment

Clicking on a deployment ID in the list navigates to the details view (`/deployments/[id]`). This page provides comprehensive information and management actions.

### 3.1. Deployment Details View
**File:** `rad-ui/webapp/src/routes/DeploymentDetails.tsx`

This page is the central hub for a specific deployment.
-   **Status Polling**: For active deployments (states other than `SUCCESS` or `FAILURE`), the component polls the `/api/deployments/[id]/status` endpoint every 10 seconds to update the progress steps.
-   **Metadata Display**: Shows the Module Name, Deployment ID, Creator, Creation Time, and current Status using the `ModuleOverview` component.

### 3.2. Viewing Logs & Outputs
**Endpoint:** `/api/deployments/[id]/logs`

Debugging and auditing are supported through dedicated tabs:
-   **Outputs**: Displays any Terraform outputs generated by the deployment.
-   **Logs**: Streams build logs directly from Google Cloud Storage (GCS) to the client. This allows users to troubleshoot failed deployments without leaving the platform.
-   **Builds**: Shows a history of Cloud Build runs associated with this deployment.

### 3.3. Updating a Deployment
**Route:** `/deployments/[id]/update`

Users can modify an existing deployment, such as changing configuration variables.
-   **Trigger**: An "Update" button (Adjustments icon) is available in the details view header.
-   **Process**:
    1.  Clicking "Update" navigates to the update flow, pre-loading the current deployment's variable values.
    2.  Users step through the configuration form (similar to the initial provision flow) to make changes.
    3.  Submitting the form triggers a new deployment (`UPDATE` action) which applies the changes via Terraform.

### 3.4. Deleting a Deployment
**Endpoint:** `DELETE /api/deployments/[id]`

Users can tear down their infrastructure when it is no longer needed.
-   **Trigger**: A "Delete" button (Trash icon) in the deployment details view.
-   **Process**:
    1.  **Confirmation**: A modal asks the user to confirm the action.
    2.  **API Call**: A `DELETE` request is sent to the backend.
    3.  **Resource Cleanup**: The backend triggers a Cloud Build process (via the `deployment-delete` Cloud Function) that executes `terraform destroy` to remove the actual cloud resources.
    4.  **Record Removal**: Once the destroy process is complete, the deployment record is marked as deleted. Deleted deployments can then be "Purged" to remove them from the history entirely.

---

## 4. Summary of Architecture

| Feature | Frontend Component | Backend/Cloud Function | Description |
| :--- | :--- | :--- | :--- |
| **List View** | `Deployments.tsx` | Firestore (`deployments` collection) | Real-time list of all user deployments. |
| **Table & Rating** | `ModuleDeployment.tsx` | `PATCH /api/deployments/[id]` | Renders list rows and handles rating updates. |
| **Details View** | `DeploymentDetails.tsx` | `/api/deployments/[id]` | Detailed metadata and status. |
| **Logs** | `ModuleLogs` | `/api/deployments/[id]/logs` | Streams build logs from GCS. |
| **Update** | `UpdateModule.tsx` | `/api/deployments` (`UPDATE`) | Re-deploys module with modified variables. |
| **Delete** | `Delete Button` | `deployment-delete` (Cloud Function) | Triggers `terraform destroy` and cleans up records. |
