# Credits & Billing System: Technical Documentation

This document provides a comprehensive technical overview of the Credits and Billing Management System. It is intended for engineers and technical staff responsible for maintaining and extending the platform.

## 1. Admin-Facing Features (Credit Settings)

The "Credit Settings" tab, located under the "Billing" page, provides administrators with a suite of tools to configure the economic model of the platform. These settings are stored in the `settings` collection in Firestore.

### 1.1. Implementation Details

-   **Frontend Component**: `rad-ui/webapp/src/routes/Billing.tsx` is the main container. It renders `rad-ui/webapp/src/components/AdminCreditForms.tsx` which holds the individual setting forms.
-   **Backend API Endpoint**: `/api/settings` is the primary endpoint for updating these settings.

### 1.2. Forms and Features

#### 1.2.1. Subscription Tiers

The Subscription Tiers feature allows administrators to create, manage, and delete different subscription levels that users can purchase to acquire credits.

-   **Frontend Component**: `rad-ui/webapp/src/components/SubscriptionTierManagement.tsx`
-   **Backend API Endpoint**: `/api/subscriptions/tiers` and `/api/subscriptions/tiers/[id]`
-   **Functionality**: Manages subscription levels for one-time credit purchases.

#### 1.2.2. Signup Credits

-   **Purpose**: To automatically grant "awarded" credits to new users.
-   **Component**: `SignupCreditForm.tsx`
-   **Settings**:
    -   `signupCreditAmount`: The number of credits to award.
    -   `monthlySignUpCredit`: If true, the `signupCreditAmount` is awarded to all users monthly.

#### 1.2.3. Adjust All User Credits

-   **Purpose**: To manually add or remove "awarded" credits for all users.
-   **Component**: `CreditAdjustmentForm.tsx`
-   **Endpoint**: `POST /api/credit/adjust`

#### 1.2.4. Referral Credits

-   **Purpose**: To award credits to a referrer when a new user signs up.
-   **Component**: `ReferralCreditForm.tsx`
-   **Setting**: `referralCreditAmount`

#### 1.2.5. Low Credit Notification

-   **Purpose**: To configure the threshold for the low credit email notification.
-   **Component**: `LowCreditForm.tsx`
-   **Setting**: `lowCreditTriggerAmount`

#### 1.2.6. Price Per Unit

-   **Purpose**: To establish the currency-to-credit conversion rate.
-   **Component**: `PricePerCreditForm.tsx`
-   **Setting**: `creditsPerUnit`

#### 1.2.7. Refresh Interval

-   **Purpose**: To set the interval for the recurring billing function (`project_credits`).
-   **Component**: `RefreshIntervalForm.tsx`
-   **Setting**: `refreshInterval` (in hours)

#### 1.2.8. Revenue Share

-   **Purpose**: To set the revenue share percentage for partners.
-   **Component**: `RevenueShareForm.tsx`
-   **Setting**: `revenueShare` (as a percentage)

## 2. Reporting and Management Tabs

### 2.1. User Credits

This tab allows administrators to view and manage the credit balances of individual users.

-   **Frontend Component**: Implemented directly within `rad-ui/webapp/src/routes/Billing.tsx`.
-   **Backend API Endpoint**: `PUT /api/users/[userId]`

### 2.2. Project Costs

A reporting tool that provides a detailed breakdown of the actual costs incurred by projects from the cloud provider's billing data.

-   **Frontend Component**: `rad-ui/webapp/src/components/ProjectCosts.tsx`
-   **Backend API Endpoint**: `GET /api/costs`
-   **Data Source**: BigQuery billing export.

### 2.3. Module Revenue / Project Revenue

This tab provides a report of the "true revenue" generated by each module, which is revenue from "purchased" credits.

-   **Frontend Component**: `rad-ui/webapp/src/components/ProjectRevenue.tsx`
-   **Backend API Endpoint**: `GET /api/revenue`

### 2.4. User Revenue

Provides a report of "true revenue" generated by specific users, crucial for the 'Agent' role.

-   **Frontend Component**: `rad-ui/webapp/src/components/UserRevenue.tsx`
-   **Backend API Endpoint**: `GET /api/revenue` (scoped by user role).

## 3. Automated Backend System (Cloud Functions)

The system uses a set of independent, event-driven Google Cloud Functions to handle the credit lifecycle asynchronously.

### 3.1. `notification_status` Function

-   **Purpose**: Processes deployment status updates and handles the one-time credit deduction for new, successful deployments.
-   **Trigger**: Pub/Sub messages from Google Cloud Build.
-   **Key Logic**: Deducts credits only when a deployment's `action` is "CREATE" and `appStatus` is "SUCCESS".

### 3.2. `project_credits` Function

-   **Purpose**: The recurring billing engine that charges users for their actual cloud resource consumption.
-   **Trigger**: Cloud Scheduler (frequency is based on the `refreshInterval` setting).
-   **Key Logic**: Queries BigQuery for costs and deducts credits. If a user has insufficient funds, it disables billing for their GCP projects via the Cloud Billing API as a safety mechanism.

### 3.3. `low_credit` Function

-   **Purpose**: Proactively notifies users when their credit balance falls below the `lowCreditTriggerAmount`.
-   **Trigger**: Cloud Scheduler (typically daily).
-   **Key Logic**: Checks user balance against the threshold and sends a throttled email notification.
